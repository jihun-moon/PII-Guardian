name: Deploy to NCP Server
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. SSH 키를 임시 파일로 저장
      - name: Write SSH private key to disk
        run: |
          printf '%b\n' "${{ secrets.NCP_SSH_KEY }}" > /tmp/ncp_key
          chmod 600 /tmp/ncp_key

      # 2. 'root' 사용자로 접속하여 배포
      - name: Deploy to NCP VM via ssh (as root)
        env:
          NCP_HOST: ${{ secrets.NCP_HOST }}
          NCP_USERNAME: ${{ secrets.NCP_USERNAME }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          ssh -i /tmp/ncp_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${NCP_USERNAME}@${NCP_HOST} \
            "GITHUB_REPOSITORY=${GITHUB_REPOSITORY} bash -s" <<'EOF'
            
            # (중요) 스크립트 실행 중 하나라도 실패하면 즉시 중단합니다.
            set -e

            echo "Connecting as: $(whoami)"

            # 0. 시스템 패키지 설치
            echo "Updating packages..."
            apt-get update
            apt-get install -y python3-pip git python3-venv
            
            # 1. 배포할 폴더 경로
            export DEPLOY_DIR="/root/PII-Guardian"
            
            # 2. 레포지토리 클론 또는 풀
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              cd /root
              git clone https://github.com/${GITHUB_REPOSITORY}.git $DEPLOY_DIR
            else
              echo "Pulling latest code..."
              cd $DEPLOY_DIR
              git pull
            fi
            
            # 3. 의존성 설치 (가상 환경 사용)
            cd $DEPLOY_DIR
            
            # 3a. 'venv' 가상 환경 폴더가 없으면 생성
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment at $DEPLOY_DIR/venv..."
              python3 -m venv venv
            fi
            
            # 3b. 가상 환경 내부의 pip를 사용하여 패키지 설치
            echo "Installing requirements into venv..."
            venv/bin/pip install -r requirements.txt
            
            # 4. Crontab 스케줄 자동 설정
            # 배포 시마다 스케줄을 덮어써서 최신 상태를 유지합니다.
            echo "Setting up scheduled tasks (cron jobs)..."
            
            # 스케줄 내용을 임시 파일에 저장
            # (중요) 시스템 python3이 아닌, venv 안의 python을 사용해야 합니다.
            CRON_FILE="/tmp/pii_guardian_cron"
            echo "0 * * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/crawler.py >> $DEPLOY_DIR/crawler.log 2>&1" > $CRON_FILE
            echo "0 1 * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/autolabeler.py >> $DEPLOY_DIR/autolabeler.log 2>&1" >> $CRON_FILE
            echo "0 2 * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/train.py >> $DEPLOY_DIR/train.log 2>&1" >> $CRON_FILE
            
            # root 유저의 Crontab을 이 파일 내용으로 교체
            crontab $CRON_FILE
            echo "Cron jobs updated."
            
            # 5. 대시보드 애플리케이션 재시작
            # (참고) pii-guardian.service 파일도 $DEPLOY_DIR/venv/bin/python 을 사용해야 합니다.
            echo "Restarting application service (dashboard)..."
            # || true는 pii-guardian.service가 최초 등록 전이라 실패해도 배포를 중단하지 않게 합니다.
            # 하지만 1단계에서 서비스 등록을 완료했다면, || true는 제거해도 좋습니다.
            systemctl restart pii-guardian.service || true
            
            echo "✅ 배포 성공! (Dashboard service restarted, Cron jobs updated)"
            EOF

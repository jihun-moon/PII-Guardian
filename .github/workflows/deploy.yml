name: Deploy to NCP Server
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. SSH 키를 임시 파일로 저장
      - name: Write SSH private key to disk
        run: |
          printf '%b\n' "${{ secrets.NCP_SSH_KEY }}" > /tmp/ncp_key
          chmod 600 /tmp/ncp_key

      # 2. 'root' 사용자로 접속하여 배포 (appleboy/ssh-action 사용)
      - name: Deploy to NCP VM via ssh-action (as root)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USERNAME }}
          key: ${{ secrets.NCP_SSH_KEY }}
          # (중요) GITHUB_REPOSITORY와 HF_TOKEN을 원격 서버로 전달합니다.
          envs: GITHUB_REPOSITORY,HF_TOKEN
          script: |
            # 스크립트 실행 중 하나라도 실패하면 즉시 중단합니다.
            set -e

            echo "Connecting as: $(whoami)"

            # 0. 시스템 패키지 설치
            echo "Updating packages..."
            apt-get update
            # (✨ 수정) jq, curl, unzip, ca-certificates 등 필수 패키지 설치
            apt-get install -y python3-pip git python3-venv wget gnupg unzip curl ca-certificates jq
            
            # (✨✨✨ 핵심 수정 v2.8 - GPG 오류 우회 ✨✨✨)
            
            # (✨ 1. Google Chrome (브라우저)만 APT로 설치)
            echo "Installing Google Chrome (GPG Keyring v2.8)..."
            curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/google-chrome-keyring.gpg
            echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
            
            # (✨ 2. apt-get update 및 Chrome 설치)
            apt-get update
            apt-get install -y google-chrome-stable
            echo "Google Chrome installed."

            # (✨ 3. ChromeDriver (조종기) 수동 설치 - GPG 오류 우회)
            echo "Installing matching ChromeDriver (Manual Download)..."
            
            # 3a. 방금 설치한 Chrome의 버전(e.g., 125.0.6422.112)을 가져옴
            CHROME_VERSION=$(google-chrome-stable --version | awk '{print $3}')
            echo "Installed Chrome version: $CHROME_VERSION"
            
            # 3b. JSON API에서 버전과 일치하는 다운로드 URL 검색
            DRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json" | jq -r --arg ver "$CHROME_VERSION" '[.versions[] | .downloads.chromedriver[] | select(.platform=="linux64" and .url | contains($ver))] | first | .url')
            
            # 3c. (예외 처리) 정확히 일치하는 버전이 없으면, 가장 가까운 최신 버전(Trunk) 검색
            if [ -z "$DRIVER_URL" ] || [ "$DRIVER_URL" = "null" ]; then
                echo "Exact match not found. Finding closest trunk version..."
                CHROME_TRUNK_VERSION=$(echo "$CHROME_VERSION" | cut -d. -f1-3)
                DRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json" | jq -r --arg ver "$CHROME_TRUNK_VERSION" '.versions[] | select(.version | startswith($ver)) | .downloads.chromedriver[] | select(.platform=="linux64") | .url')
            fi

            # 3d. (최종 예외 처리) 그래도 없으면, 그냥 최신 안정 버전(last known good) 사용
             if [ -z "$DRIVER_URL" ] || [ "$DRIVER_URL" = "null" ]; then
                echo "Trunk match not found. Using latest known good stable version..."
                DRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json" | jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform=="linux64") | .url')
             fi

            echo "Downloading ChromeDriver from: $DRIVER_URL"
            
            # 3e. 다운로드, 압축 해제, /usr/bin/으로 이동
            wget -q -O /tmp/chromedriver.zip "$DRIVER_URL"
            # (중요) 압축 파일 안에 'chromedriver-linux64/chromedriver'처럼 폴더가 있을 수 있음
            unzip -o /tmp/chromedriver.zip -d /tmp/
            # (중요) chromedriver 바이너리만 /usr/bin/으로 이동
            if [ -f "/tmp/chromedriver-linux64/chromedriver" ]; then
                mv /tmp/chromedriver-linux64/chromedriver /usr/bin/chromedriver
                rm -rf /tmp/chromedriver-linux64
            elif [ -f "/tmp/chromedriver" ]; then
                mv /tmp/chromedriver /usr/bin/chromedriver
            else
                echo "Error: Could not find 'chromedriver' binary in unzipped file."
                exit 1
            fi
            
            chmod +x /usr/bin/chromedriver
            rm /tmp/chromedriver.zip
            echo "ChromeDriver installed to /usr/bin/chromedriver"

            # (✨✨✨ 수정 끝 ✨✨✨)
            
            # 1. 배포할 폴더 경로
            export DEPLOY_DIR="/root/PII-Guardian"
            
            # 2. 레포지토리 클론 또는 풀
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              cd /root
              git clone https://github.com/${GITHUB_REPOSITORY}.git $DEPLOY_DIR
            else
              echo "Pulling latest code..."
              cd $DEPLOY_DIR
              git fetch origin
              git reset --hard origin/main
              git pull
            fi
            
            # 3. 의존성 설치 (가상 환경 사용)
            cd $DEPLOY_DIR
            
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment at $DEPLOY_DIR/venv..."
              python3 -m venv venv
            fi
            
            echo "Installing requirements into venv..."
            venv/bin/pip install -r requirements.txt
            
            # 3c. Hugging Face Hub 인증 (파일로도 저장)
            echo "Setting up Hugging Face token file..."
            mkdir -p /root/.cache/huggingface
            echo -n "$HF_TOKEN" > /root/.cache/huggingface/token
            
            # 4. Crontab 스케줄 자동 설정
            echo "Setting up scheduled tasks (cron jobs)..."
            CRON_FILE="/tmp/pii_guardian_cron"
            
            # (수정 1) crawler.py
            echo "0 * * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/crawler.py >> $DEPLOY_DIR/crawler.log 2>&1" > $CRON_FILE
            
            # (수정 2) autolabeler.py
            echo "0 1 * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/autolabeler.py >> $DEPLOY_DIR/autolabeler.log 2>&1" >> $CRON_FILE
            
            # (수정 3) train.py
            echo "0 2 * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/train.py >> $DEPLOY_DIR/train.log 2>&1" >> $CRON_FILE
            
            crontab $CRON_FILE
            echo "Cron jobs updated."
            
            # 5. 대시보드 애플리케이션 재시작
            echo "Restarting application service (dashboard)..."
            systemctl restart pii-guardian.service || true
            
            echo "✅ 배포 성공! (Chrome/ChromeDriver installed, Dashboard restarted, Cron jobs updated)"


name: Deploy to NCP Server
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. SSH 키를 임시 파일로 저장
      - name: Write SSH private key to disk
        run: |
          printf '%b\n' "${{ secrets.NCP_SSH_KEY }}" > /tmp/ncp_key
          chmod 600 /tmp/ncp_key

      # 2. 'root' 사용자로 접속하여 배포 (디버그 모드 -v 제거)
      - name: Deploy to NCP VM via ssh (as root)
        env:
          NCP_HOST: ${{ secrets.NCP_HOST }}
          # (중요) 이 시크릿은 'root'여야 합니다.
          NCP_USERNAME: ${{ secrets.NCP_USERNAME }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # (참고) SSH 접속이 성공했으므로 디버그 옵션(-v)을 제거했습니다.
          ssh -i /tmp/ncp_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${NCP_USERNAME}@${NCP_HOST} \
            "GITHUB_REPOSITORY=${GITHUB_REPOSITORY} bash -s" <<'EOF'
            
            # (중요) 스크립트 실행 중 하나라도 실패하면 즉시 중단합니다.
            set -e

            # 'root'로 접속되었는지 확인
            echo "Connecting as: $(whoami)"

            # 0. 시스템 패키지 설치
            echo "Updating packages..."
            apt-get update
            # 'python3-venv' 패키지를 추가 (가상 환경 생성에 필수)
            apt-get install -y python3-pip git python3-venv
            
            # 1. 배포할 폴더 경로를 'root' 사용자의 홈 디렉토리로 변경
            export DEPLOY_DIR="/root/PII-Guardian"
            
            # 2. 레포지토리 클론 또는 풀
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              # 상위 디렉토리도 /root 로 변경
              cd /root
              git clone https://github.com/${GITHUB_REPOSITORY}.git $DEPLOY_DIR
            else
              echo "Pulling latest code..."
              cd $DEPLOY_DIR
              git pull
            fi
            
            # 3. 의존성 설치 (가상 환경 사용)
            cd $DEPLOY_DIR
            
            # 3a. 'venv'라는 이름의 가상 환경 폴더가 없으면 생성
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment at $DEPLOY_DIR/venv..."
              python3 -m venv venv
            fi
            
            # 3b. 가상 환경 내부의 pip를 사용하여 패키지 설치
            echo "Installing requirements into venv..."
            # (기존: pip3 install...)
            venv/bin/pip install -r requirements.txt
            
            # 4. 애플리케이션 재시작 (root는 'sudo'가 필요 없습니다)
            # (참고: 4단계가 성공하려면, pii-guardian.service 파일도
            # /root/PII-Guardian/venv/bin/python 을 사용하도록 설정되어 있어야 합니다.)
            echo "Restarting application service..."
            systemctl restart pii-guardian.service || true
            
            echo "✅ 배포 성공!"
          EOF


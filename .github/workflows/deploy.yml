name: Deploy to NCP Server
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. SSH 키를 임시 파일로 저장
      - name: Write SSH private key to disk
        run: |
          printf '%b\n' "${{ secrets.NCP_SSH_KEY }}" > /tmp/ncp_key
          chmod 600 /tmp/ncp_key

      # 2. 'root' 사용자로 접속하여 배포
      - name: Deploy to NCP VM via ssh (as root)
        env:
          NCP_HOST: ${{ secrets.NCP_HOST }}
          # (중요) 이 시크릿은 'root'여야 합니다.
          NCP_USERNAME: ${{ secrets.NCP_USERNAME }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          ssh -i /tmp/ncp_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${NCP_USERNAME}@${NCP_HOST} \
            "GITHUB_REPOSITORY=${GITHUB_REPOSITORY} bash -s" <<'EOF'
            
            # (중요) 스크립트 실행 중 하나라도 실패하면 즉시 중단합니다.
            set -e

            # 'root'로 접속되었는지 확인
            echo "Connecting as: $(whoami)"

            # 0. 시스템 패키지 설치 (root는 'sudo'가 필요 없습니다)
            echo "Updating packages..."
            apt-get update
            apt-get install -y python3-pip git
            
            # 1. 배포할 폴더 경로를 'root' 사용자의 홈 디렉토리로 변경
            export DEPLOY_DIR="/root/PII-Guardian"
            
            # 2. 레포지토리 클론 또는 풀
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              # 상위 디렉토리도 /root 로 변경
              cd /root
              git clone https://github.com/${GITHUB_REPOSITORY}.git $DEPLOY_DIR
            else
              echo "Pulling latest code..."
              cd $DEPLOY_DIR
              git pull
            fi
            
            # 3. 의존성 설치 (root 권한으로 설치)
            cd $DEPLOY_DIR
            pip3 install -r requirements.txt
            
            # 4. 애플리케이션 재시작 (root는 'sudo'가 필요 없습니다)
            echo "Restarting application service..."
            systemctl restart pii-guardian.service || true
            
            echo "✅ 배포 성공!"
          EOF


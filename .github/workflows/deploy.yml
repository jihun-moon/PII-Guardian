name: Deploy to NCP Server
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. SSH 키를 임시 파일로 저장
      - name: Write SSH private key to disk
        run: |
          printf '%b\n' "${{ secrets.NCP_SSH_KEY }}" > /tmp/ncp_key
          chmod 600 /tmp/ncp_key

      # 2. 'root' 사용자로 접속하여 배포 (appleboy/ssh-action 사용)
      - name: Deploy to NCP VM via ssh-action (as root)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USERNAME }}
          key: ${{ secrets.NCP_SSH_KEY }}
          # (중요) GITHUB_REPOSITORY와 HF_TOKEN을 원격 서버로 전달합니다.
          envs: GITHUB_REPOSITORY,HF_TOKEN
          script: |
            # 스크립트 실행 중 하나라도 실패하면 즉시 중단합니다.
            set -e

            echo "Connecting as: $(whoami)"

            # 0. 시스템 패키지 설치
            echo "Updating packages..."
            apt-get update
            apt-get install -y python3-pip git python3-venv
            
            # 1. 배포할 폴더 경로
            export DEPLOY_DIR="/root/PII-Guardian"
            
            # 2. 레포지토리 클론 또는 풀
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              cd /root
              git clone https://github.com/${GITHUB_REPOSITORY}.git $DEPLOY_DIR
            else
              echo "Pulling latest code..."
              cd $DEPLOY_DIR
              # (✨ 핵심 수정) git pull 충돌 방지
              # 서버에서 수동으로 변경한 내용이 있더라도, 깃허브의 코드로 강제 덮어쓰기
              git fetch origin
              git reset --hard origin/main
              git pull
            fi
            
            # 3. 의존성 설치 (가상 환경 사용)
            cd $DEPLOY_DIR
            
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment at $DEPLOY_DIR/venv..."
              python3 -m venv venv
            fi
            
            echo "Installing requirements into venv..."
            venv/bin/pip install -r requirements.txt
            
            # 3c. Hugging Face Hub 인증 (파일로도 저장)
            echo "Setting up Hugging Face token file..."
            mkdir -p /root/.cache/huggingface
            echo -n "$HF_TOKEN" > /root/.cache/huggingface/token
            
            # 4. Crontab 스케줄 자동 설정
            echo "Setting up scheduled tasks (cron jobs)..."
            CRON_FILE="/tmp/pii_guardian_cron"
            
            # (수정 1) crawler.py
            echo "0 * * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/crawler.py >> $DEPLOY_DIR/crawler.log 2>&1" > $CRON_FILE
            
            # (수정 2) autolabeler.py
            echo "0 1 * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/autolabeler.py >> $DEPLOY_DIR/autolabeler.log 2>&1" >> $CRON_FILE
            
            # (수정 3) train.py
            echo "0 2 * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/train.py >> $DEPLOY_DIR/train.log 2>&1" >> $CRON_FILE
            
            crontab $CRON_FILE
            echo "Cron jobs updated."
            
            # 5. 대시보드 애플리케이션 재시작
            echo "Restarting application service (dashboard)..."
            systemctl restart pii-guardian.service || true
            
            echo "✅ 배포 성공! (Dashboard service restarted, Cron jobs updated)"


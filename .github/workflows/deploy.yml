name: Deploy to NCP Server
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. SSH 키를 임시 파일로 저장
      - name: Write SSH private key to disk
        run: |
          printf '%b\n' "${{ secrets.NCP_SSH_KEY }}" > /tmp/ncp_key
          chmod 600 /tmp/ncp_key

      # 2. 'root' 사용자로 접속하여 배포 (appleboy/ssh-action 사용)
      - name: Deploy to NCP VM via ssh-action (as root)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USERNAME }}
          key: ${{ secrets.NCP_SSH_KEY }}
          # (중요) GITHUB_REPOSITORY와 HF_TOKEN을 원격 서버로 전달합니다.
          envs: GITHUB_REPOSITORY,HF_TOKEN
          script: |
            # 스크립트 실행 중 하나라도 실패하면 즉시 중단합니다.
            set -e

            echo "Connecting as: $(whoami)"

            # 0. 시스템 패키지 설치
            echo "Updating packages..."
            apt-get update
            # (✨ 수정) curl, ca-certificates 추가
            apt-get install -y python3-pip git python3-venv wget gnupg unzip curl ca-certificates
            
            # (✨✨✨ 핵심 수정 v2.6 - GPG 오류 수정 ✨✨✨)
            
            # (✨ 1. Google Chrome 설치 - Modern GPG Keyring 방식)
            echo "Installing Google Chrome (GPG Keyring)..."
            # 1a. GPG 키 저장을 위한 디렉토리 생성
            mkdir -p /etc/apt/keyrings
            # 1b. Google Chrome GPG 키 다운로드, dearmor 후 저장 (curl 사용)
            curl -fsSL https://dl-ssl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /etc/apt/keyrings/google-chrome.gpg
            # 1c. Chrome apt 저장소 설정 (signed-by 옵션 추가)
            echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | tee /etc/apt/sources.list.d/google-chrome.list > /dev/null
            
            # (✨ 2. ChromeDriver 공식 저장소 추가 - Modern GPG Keyring 방식)
            echo "Installing ChromeDriver (GPG Keyring)..."
            # 2a. ChromeDriver GPG 키 다운로드, dearmor 후 저장 (curl 사용)
            curl -fsSL https://edgedl.me/chrome-for-testing/linux/latest/KEY.gpg | gpg --dearmor -o /etc/apt/keyrings/chrome-for-testing.gpg
            # 2b. ChromeDriver apt 저장소 설정 (signed-by 옵션 추가)
            echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/chrome-for-testing.gpg] https://edgedl.me/chrome-for-testing/deb/ stable main" | tee /etc/apt/sources.list.d/chrome-for-testing.list > /dev/null
            
            # (✨ 3. apt-get update를 모든 저장소 추가 *후*에 실행)
            echo "Updating apt lists..."
            apt-get update
            
            # (✨ 4. Chrome과 ChromeDriver를 apt로 설치)
            echo "Installing chrome and chromedriver..."
            apt-get install -y google-chrome-stable chromedriver
            
            echo "Chrome and ChromeDriver installed via apt."
            
            # 1. 배포할 폴더 경로
            export DEPLOY_DIR="/root/PII-Guardian"
            
            # 2. 레포지토리 클론 또는 풀
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              cd /root
              git clone https://github.com/${GITHUB_REPOSITORY}.git $DEPLOY_DIR
            else
              echo "Pulling latest code..."
              cd $DEPLOY_DIR
              git fetch origin
              git reset --hard origin/main
              git pull
            fi
            
            # 3. 의존성 설치 (가상 환경 사용)
            cd $DEPLOY_DIR
            
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment at $DEPLOY_DIR/venv..."
              python3 -m venv venv
            fi
            
            echo "Installing requirements into venv..."
            venv/bin/pip install -r requirements.txt
            
            # 3c. Hugging Face Hub 인증 (파일로도 저장)
            echo "Setting up Hugging Face token file..."
            mkdir -p /root/.cache/huggingface
            echo -n "$HF_TOKEN" > /root/.cache/huggingface/token
            
            # 4. Crontab 스케줄 자동 설정
            echo "Setting up scheduled tasks (cron jobs)..."
            CRON_FILE="/tmp/pii_guardian_cron"
            
            # (수정 1) crawler.py
            echo "0 * * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/crawler.py >> $DEPLOY_DIR/crawler.log 2>&1" > $CRON_FILE
            
            # (수정 2) autolabeler.py
            echo "0 1 * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/autolabeler.py >> $DEPLOY_DIR/autolabeler.log 2>&1" >> $CRON_FILE
            
            # (수정 3) train.py
            echo "0 2 * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/train.py >> $DEPLOY_DIR/train.log 2>&1" >> $CRON_FILE
            
            crontab $CRON_FILE
            echo "Cron jobs updated."
            
            # 5. 대시보드 애플리케이션 재시작
            echo "Restarting application service (dashboard)..."
            systemctl restart pii-guardian.service || true
            
            echo "✅ 배포 성공! (Chrome/ChromeDriver installed, Dashboard restarted, Cron jobs updated)"


name: Deploy to NCP Server
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to NCP VM via SSH
      # @master ë³´ë‹¤ëŠ” ì•ˆì •ì ì¸ ë²„ì „ì„ ëª…ì‹œí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        script: |
          # 0. (ê¶Œì¥) ì´ íŒ¨í‚¤ì§€ë“¤ì€ í•œ ë²ˆë§Œ ì„¤ì¹˜í•˜ë©´ ë˜ë¯€ë¡œ, 
          # ì„œë²„ì— ë¯¸ë¦¬ ì„¤ì¹˜í•´ë‘ê³  ì´ ë¼ì¸ë“¤ì€ ì§€ìš°ëŠ” ê²ƒì´ ë°°í¬ ì†ë„ì— ì¢‹ìŠµë‹ˆë‹¤.
          apt-get update
          apt-get install python3-pip git -y
          
          # 1. ë°°í¬í•  í´ë” ê²½ë¡œë¥¼ ë³€ìˆ˜ë¡œ ì§€ì • (ğŸš¨ PII-Guardianì„ ì‹¤ì œ í´ë”ëª…ìœ¼ë¡œ ë³€ê²½)
          # (ê¶Œì¥) /root ë³´ë‹¤ëŠ” /var/www/PII-Guardian ê°™ì€ ê²½ë¡œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.
          export DEPLOY_DIR="/root/PII-Guardian"
          
          # 2. ë ˆí¬ì§€í† ë¦¬ í´ë¡  ë˜ëŠ” í’€
          if [ ! -d "$DEPLOY_DIR" ]; then
            echo "Cloning repository..."
            cd /root # ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            git clone https://github.com/${{ github.repository }}.git $DEPLOY_DIR
          else
            echo "Pulling latest code..."
            cd $DEPLOY_DIR
            git pull
          fi
          
          # 3. ì˜ì¡´ì„± ì„¤ì¹˜
          cd $DEPLOY_DIR
          pip3 install -r requirements.txt
          
          # 4. (ğŸš¨ğŸš¨ ë§¤ìš° ì¤‘ìš”) ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
          # ì´ ë¶€ë¶„ì€ ì„œë²„ì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì— ë§ê²Œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
          
          # ì˜ˆì‹œ 1: systemdë¡œ ì„œë¹„ìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ” ê²½ìš° (ê°€ì¥ ì¼ë°˜ì )
          # 'pii-guardian.service'ëŠ” ì‹¤ì œ ì„œë¹„ìŠ¤ íŒŒì¼ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.
          echo "Restarting application service..."
          systemctl restart pii-guardian.service
          
          # ì˜ˆì‹œ 2: pm2ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°
          # 'pii-guardian'ì€ pm2ì— ë“±ë¡ëœ ì•± ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.
          # pm2 reload pii-guardian
          
          echo "âœ… ë°°í¬ ì„±ê³µ!"
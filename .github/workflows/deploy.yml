name: Deploy to NCP Server
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. SSH 키를 임시 파일로 저장
      - name: Write SSH private key to disk
        run: |
          printf '%b\n' "${{ secrets.NCP_SSH_KEY }}" > /tmp/ncp_key
          chmod 600 /tmp/ncp_key

      # 2. 'root' 사용자로 접속하여 배포 (appleboy/ssh-action 사용)
      - name: Deploy to NCP VM via ssh-action (as root)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USERNAME }}
          key: ${{ secrets.NCP_SSH_KEY }}
          # (중요) GITHUB_REPOSITORY와 HF_TOKEN을 원격 서버로 전달합니다.
          envs: GITHUB_REPOSITORY,HF_TOKEN
          script: |
            # 스크립트 실행 중 하나라도 실패하면 즉시 중단합니다.
            set -e

            echo "Connecting as: $(whoami)"

            # 0. 시스템 패키지 설치
            echo "Updating packages..."
            apt-get update
            # (✨ 수정) gnupg 제외, jq, curl, unzip, ca-certificates 등 필수 패키지 설치
            apt-get install -y python3-pip git python3-venv wget unzip curl ca-certificates jq
            
            # (✨✨✨ 핵심 수정 v2.9 - GPG/APT 완전 우회 ✨✨✨)
            
            echo "Installing Chrome and ChromeDriver (Manual Download v2.9)..."
            
            # 1. 최신 안정화 버전(Stable)의 Chrome/ChromeDriver 다운로드 URL을 JSON API에서 찾음
            LATEST_STABLE_JSON=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json")
            
            # 2. Linux용 Chrome 브라우저 URL 추출
            CHROME_URL=$(echo $LATEST_STABLE_JSON | jq -r '.channels.Stable.downloads.chrome[] | select(.platform=="linux64") | .url')
            
            # 3. Linux용 ChromeDriver URL 추출
            DRIVER_URL=$(echo $LATEST_STABLE_JSON | jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform=="linux64") | .url')
            
            echo "Downloading Chrome from: $CHROME_URL"
            echo "Downloading ChromeDriver from: $DRIVER_URL"
            
            # 4. Chrome 다운로드 및 /opt/에 압축 해제
            wget -q -O /tmp/chrome.zip "$CHROME_URL"
            unzip -o /tmp/chrome.zip -d /opt/
            
            # 5. ChromeDriver 다운로드 및 /opt/에 압축 해제
            wget -q -O /tmp/chromedriver.zip "$DRIVER_URL"
            unzip -o /tmp/chromedriver.zip -d /opt/
            
            # 6. (중요) 실행 파일들을 /usr/bin/으로 심볼릭 링크 생성
            # (Chrome 브라우저 실행 파일)
            ln -sf /opt/chrome-linux64/chrome /usr/bin/google-chrome-stable
            # (ChromeDriver 실행 파일)
            ln -sf /opt/chromedriver-linux64/chromedriver /usr/bin/chromedriver
            
            # 7. 임시 파일 삭제
            rm /tmp/chrome.zip /tmp/chromedriver.zip
            
            echo "Chrome and ChromeDriver installed to /opt/ and linked to /usr/bin/"

            # (✨✨✨ 수정 끝 ✨✨✨)
            
            # 1. 배포할 폴더 경로
            export DEPLOY_DIR="/root/PII-Guardian"
            
            # 2. 레포지토리 클론 또는 풀
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              cd /root
              git clone https://github.com/${GITHUB_REPOSITORY}.git $DEPLOY_DIR
            else
              echo "Pulling latest code..."
              cd $DEPLOY_DIR
              git fetch origin
              git reset --hard origin/main
              git pull
            fi
            
            # 3. 의존성 설치 (가상 환경 사용)
            cd $DEPLOY_DIR
            
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment at $DEPLOY_DIR/venv..."
              python3 -m venv venv
            fi
            
            echo "Installing requirements into venv..."
            venv/bin/pip install -r requirements.txt
            
            # 3c. Hugging Face Hub 인증 (파일로도 저장)
            echo "Setting up Hugging Face token file..."
            mkdir -p /root/.cache/huggingface
            echo -n "$HF_TOKEN" > /root/.cache/huggingface/token
            
            # 4. Crontab 스케줄 자동 설정
            echo "Setting up scheduled tasks (cron jobs)..."
            CRON_FILE="/tmp/pii_guardian_cron"
            
            # (수정 1) crawler.py
            echo "0 * * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/crawler.py >> $DEPLOY_DIR/crawler.log 2>&1" > $CRON_FILE
            
            # (수정 2) autolabeler.py
            echo "0 1 * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/autolabeler.py >> $DEPLOY_DIR/autolabeler.log 2>&1" >> $CRON_FILE
            
            # (수정 3) train.py
            echo "0 2 * * * $DEPLOY_DIR/venv/bin/python $DEPLOY_DIR/train.py >> $DEPLOY_DIR/train.log 2>&1" >> $CRON_FILE
            
            crontab $CRON_FILE
            echo "Cron jobs updated."
            
            # 5. 대시보드 애플리케이션 재시작
            echo "Restarting application service (dashboard)..."
            systemctl restart pii-guardian.service || true
            
            echo "✅ 배포 성공! (Chrome/ChromeDriver installed, Dashboard restarted, Cron jobs updated)"


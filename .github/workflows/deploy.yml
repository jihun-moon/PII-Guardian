name: Deploy to NCP Server
on:
  push:
    branches: [ main ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. SSH í‚¤ë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
      - name: Write SSH private key to disk
        run: |
          printf '%b\n' "${{ secrets.NCP_SSH_KEY }}" > /tmp/ncp_key
          chmod 600 /tmp/ncp_key

      # 2. 'root' ì‚¬ìš©ìë¡œ ì ‘ì†í•˜ì—¬ ë°°í¬
      - name: Deploy and Restart Services (as root)
        env:
          NCP_HOST: ${{ secrets.NCP_HOST }}
          NCP_USERNAME: ${{ secrets.NCP_USERNAME }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          ssh -i /tmp/ncp_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${NCP_USERNAME}@${NCP_HOST} \
            "GITHUB_REPOSITORY=${GITHUB_REPOSITORY} bash -s" <<'EOF'
            
            set -e # ì˜¤ë¥˜ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

            export DEPLOY_DIR="/root/PII-Guardian"
            VENV_PATH="$DEPLOY_DIR/venv/bin"
            
            echo "--- 1. ì‹œìŠ¤í…œ ë° ì½”ë“œ ì—…ë°ì´íŠ¸ ì‹œì‘ ---"
            
            # 0. ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ì—…ë°ì´íŠ¸
            apt-get update
            apt-get install -y python3-pip git python3-venv
            
            # 1. ë ˆí¬ì§€í† ë¦¬ í´ë¡ /í’€
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "Cloning repository..."
              cd /root
              git clone https://github.com/${GITHUB_REPOSITORY}.git $DEPLOY_DIR
            else
              echo "Pulling latest code..."
              cd $DEPLOY_DIR
              git pull
            fi
            
            # 2. ê°€ìƒ í™˜ê²½ ì„¤ì • ë° ì˜ì¡´ì„± ì„¤ì¹˜
            cd $DEPLOY_DIR
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment..."
              python3 -m venv venv
            fi
            echo "Installing/Updating Python requirements..."
            "$VENV_PATH/pip" install -r requirements.txt
            
            echo "--- 2. ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ì—…ë°ì´íŠ¸ ë°˜ì˜) ---"
            
            # 3. Streamlit ëŒ€ì‹œë³´ë“œ ê°•ì œ ì¢…ë£Œ (ìƒˆ ì½”ë“œë¥¼ ë¡œë“œí•˜ê¸° ìœ„í•´ í•„ìˆ˜)
            echo "Killing old dashboard process..."
            # 8501 í¬íŠ¸ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì•„ì„œ ì¢…ë£Œí•©ë‹ˆë‹¤.
            /usr/sbin/fuser -k 8501/tcp || true

            # 4. Crontab ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ê°€ìƒ í™˜ê²½ ê²½ë¡œë¡œ ìˆ˜ì • ë° ì¬ë“±ë¡
            echo "Updating crontab paths..."
            CRON_TEMP_FILE=$(mktemp)
            
            # ê¸°ì¡´ crontab ë‚´ìš©ì„ ì„ì‹œ íŒŒì¼ë¡œ ë³µì‚¬
            crontab -l | grep -v 'my-cool-bot' > "$CRON_TEMP_FILE" || true

            # ìƒˆë¡œìš´ ìŠ¤ì¼€ì¤„ì„ ì„ì‹œ íŒŒì¼ì— ì¶”ê°€ (ğŸš¨ my-cool-bot ëŒ€ì‹  PII-Guardian ì‚¬ìš©)
            # @reboot ëª…ë ¹ì–´ëŠ” ìƒˆ ì½”ë“œë¥¼ ë°˜ì˜í•˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
            cat <<EOL >> "$CRON_TEMP_FILE"
# --- PII-Guardian AUTO SCHEDULE (Updated by GitHub Actions) ---
# 1. (ë¶€íŒ… ì‹œ) ì•„ì¹¨ì— ì„œë²„ ì¼œì§€ë©´ 'ì¤‘ì•™ ê´€ì œì†Œ' ì‹¤í–‰
@reboot $VENV_PATH/streamlit run $DEPLOY_DIR/dashboard.py --server.port=8501

# 2. (ë§¤ì‹œê°„) 'ì‹ ì… ë´‡(crawler.py)'ì´ ë§¤ì‹œ ì •ê°ì— 'ì˜ì‹¬' ë‚´ì—­ ìˆ˜ì§‘
0 * * * * $VENV_PATH/python $DEPLOY_DIR/crawler.py >> $DEPLOY_DIR/crawler.log 2>&1

# 3. (ë§¤ì¼ ìƒˆë²½ 1ì‹œ) 'ì „ë¬¸ê°€ ë´‡(autolabeler.py)'ì´ 'ì •ë‹µ' ìƒì„±
0 1 * * * $VENV_PATH/python $DEPLOY_DIR/autolabeler.py >> $DEPLOY_DIR/autolabeler.log 2>&1

# 4. (ë§¤ì¼ ìƒˆë²½ 2ì‹œ) 'í•™ìŠµê¸°(train.py)'ê°€ 'ì •ë‹µ'ìœ¼ë¡œ ì¬í•™ìŠµ
0 2 * * * $VENV_PATH/python $DEPLOY_DIR/train.py >> $DEPLOY_DIR/train.log 2>&1
# -----------------------------------------------------------------
EOL

            # ì„ì‹œ íŒŒì¼ì„ Crontabì— ë‹¤ì‹œ ë“±ë¡
            crontab "$CRON_TEMP_FILE"
            rm "$CRON_TEMP_FILE"
            
            # 5. ëŒ€ì‹œë³´ë“œ ë‹¤ì‹œ ì‹¤í–‰ (ìƒˆ ì½”ë“œ ë°˜ì˜)
            echo "Starting new dashboard process..."
            # nohupìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬ SSH ì ‘ì†ì´ ëŠê²¨ë„ ê³„ì† ì‹¤í–‰ë˜ë„ë¡ í•©ë‹ˆë‹¤.
            nohup "$VENV_PATH/streamlit" run "$DEPLOY_DIR/dashboard.py" --server.port=8501 > /dev/null 2>&1 &
            
            echo "âœ… ë°°í¬ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì„±ê³µ! (ëŒ€ì‹œë³´ë“œëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë‹¤ì‹œ ì‹¤í–‰ë¨)"
          EOF

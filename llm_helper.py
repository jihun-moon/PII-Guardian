# ğŸ¤– (AI) HyperCLOVA API í˜¸ì¶œ ë„ìš°ë¯¸
# (v2.2 - Prompt Engineering + ë¡œê·¸ ì¤‘ë³µ ì œê±°)
# ----------------------------------------------------
# 'autolabeler.py'ê°€ ì´ íŒŒì¼ì„ importí•˜ì—¬ LLMì˜ íŒë‹¨ì„ ë°›ìŠµë‹ˆë‹¤.
# ----------------------------------------------------

import requests
import json
import config # (ìš°ë¦¬ì˜ ë¹„ë°€ í‚¤ ë¡œë“œ)
import logging # (âœ¨ ì‹ ê·œ)

# (âœ¨ ì‹ ê·œ) autolabelerì™€ ê°™ì€ ë¡œê±°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
logger = logging.getLogger(__name__)

# (âœ¨âœ¨âœ¨ í•µì‹¬ ìˆ˜ì • v2.2: Prompt Engineering ê°•í™” âœ¨âœ¨âœ¨)
# AIê°€ 'ì‹ ì…' ë´‡ì˜ ì˜¤íƒ(False Positive)ê¹Œì§€ ê±¸ëŸ¬ë‚´ë„ë¡ ì§€ì¹¨ì„ ëŒ€í­ ê°•í™”í•©ë‹ˆë‹¤.
SYSTEM_PROMPT = """
ë‹¹ì‹ ì€ ìµœê³ ì˜ ê°œì¸ì •ë³´ ë³´ì•ˆ ì „ë¬¸ê°€(LLM)ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì—ê²ŒëŠ” 'ì‹ ì…' ë´‡ì´ 1ì°¨ë¡œ íƒì§€í•œ 'ì˜ì‹¬' ëª©ë¡ì´ [íƒì§€ëœ PII]ì™€ [ë¬¸ë§¥] ì„¸íŠ¸ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
'ì‹ ì…' ë´‡ì€ **ì˜¤ì§ ì •ê·œì‹(RegEx)ë§Œìœ¼ë¡œ** íƒì§€í•˜ê¸° ë•Œë¬¸ì—, ë¬¸ë§¥ì„ ì „í˜€ ì´í•´í•˜ì§€ ëª»í•˜ë©° **ì¹˜ëª…ì ì¸ ì˜¤íƒ(False Positive)ì„ ëŒ€ëŸ‰ìœ¼ë¡œ í¬í•¨í•©ë‹ˆë‹¤.**

ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” [ë¬¸ë§¥]ê³¼ [íƒì§€ëœ PII]ë¥¼ ë¹„íŒì ìœ¼ë¡œ ê²€í† í•˜ì—¬, ì´ íƒì§€ê°€ 'ì§„ì§œ ìœ ì¶œ'ì¸ì§€, ì•„ë‹ˆë©´ 'ì‹ ì…' ë´‡ì˜ 'ì˜¤íƒ'ì¸ì§€ë¥¼ íŒë‹¨í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

[íŒë‹¨ ë¡œì§]
1.  **[ë¬¸ë§¥]ì„ ë¨¼ì € í™•ì¸í•˜ì‹­ì‹œì˜¤.** [ë¬¸ë§¥]ì´ 'GitHub UI', 'Skip to content', 'Navigation Menu' ë“±ê³¼ ê°™ì´ **ì›¹ì‚¬ì´íŠ¸ì˜ UI/ë©”ë‰´ í…ìŠ¤íŠ¸**ì¸ ê²½ìš°, [íƒì§€ëœ PII]ê°€ ì‹¤ì œ ìœ ì¶œ ì •ë³´(ì˜ˆ: `im-key-prod-...`)ê°€ ì•„ë‹Œ í•œ, **ëŒ€ë¶€ë¶„ 'ê³µê°œ' (ì˜¤íƒ)ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.**
2.  **[íƒì§€ëœ PII]ì˜ í˜•íƒœë¥¼ ë¹„íŒì ìœ¼ë¡œ ê²€í† í•˜ì‹­ì‹œì˜¤.**

[ë¶„ë¥˜ ê¸°ì¤€]
1.  **'ìœ ì¶œ' (Leak):**
    * ë¹„ë°€ë²ˆí˜¸, API í‚¤ (ì˜ˆ: `im-key-prod-...`), ì£¼ë¯¼ë²ˆí˜¸ (ì˜ˆ: `901231-1234567`), ì—¬ê¶Œë²ˆí˜¸, ì¹´ë“œë²ˆí˜¸ (ì˜ˆ: `4500-1234-...`).
    * ë¬¸ë§¥ìƒ ëª…ë°±íˆ **ê°œì¸ ì‹ë³„ ì •ë³´** (ì˜ˆ: `sunsin_lee@naver.com`, `010-1111-2222`).
    * ë‚´ë¶€ IP (ì˜ˆ: `192.168.x.x`), ë‚´ë¶€ ì„œë²„ ì£¼ì†Œ (ì˜ˆ: `jenkins.internal.dgb.co.kr`).

2.  **'ê³µê°œ' (Public) - (ì‹ ì… ë´‡ì˜ ì˜¤íƒ í¬í•¨):**
    * ì›¹ì‚¬ì´íŠ¸ í•˜ë‹¨ì˜ ê³ ê°ì„¼í„° ì´ë©”ì¼(ì˜ˆ: `support@...`, `recruit@...`), ëŒ€í‘œ ì „í™”ë²ˆí˜¸(ì˜ˆ: `1588-XXXX`), ê³µì‹ ì£¼ì†Œ.
    * `test@example.com`, `010-0000-0000`ì²˜ëŸ¼ ëª…ë°±í•œ **ìƒ˜í”Œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°.**
    * **[ê°€ì¥ ì¤‘ìš”]** `100 101 102`, `124 125 126`, `123-45-67890`(ì‚¬ì—…ìë²ˆí˜¸)ì²˜ëŸ¼, **[íƒì§€ëœ PII] ìì²´ê°€ ê°œì¸ì •ë³´ë¡œ ë³´ê¸° ì–´ë ¤ìš´ ë‹¨ìˆœ ìˆ«ì/ë¬¸ì ë‚˜ì—´**ì¸ ê²½ìš°. (ì‹ ì… ë´‡ì´ ê³„ì¢Œë²ˆí˜¸ë‚˜ ì£¼ë¯¼ë²ˆí˜¸ ì •ê·œì‹ìœ¼ë¡œ ì˜¤íƒí•œ ê²½ìš°ì„).
    * [ë¬¸ë§¥]ì´ 'ì´ë©”ì¼ ì •ê·œì‹ ì˜ˆì œ:' ë“±ì´ë©° [íƒì§€ëœ PII]ê°€ `A-Za-z0-9` ê°™ì€ **ì½”ë“œ/ì •ê·œì‹ì˜ ì¼ë¶€**ì¸ ê²½ìš°.

ë°˜ë“œì‹œ 'ìœ ì¶œ' ë˜ëŠ” 'ê³µê°œ' ë‘˜ ì¤‘ í•˜ë‚˜ë¡œë§Œ ë‹µí•˜ê³ , ê·¸ ì´ìœ ë¥¼ 1ì¤„ë¡œ ì„¤ëª…í•˜ì„¸ìš”.
JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•˜ì„¸ìš”: {"label": "ìœ ì¶œ/ê³µê°œ", "reason": "ì´ìœ "}
"""

def get_llm_judgment(context, pii_content):
    """
    HyperCLOVA X (CLOVA Studio) APIë¥¼ í˜¸ì¶œí•˜ì—¬
    íƒì§€ëœ PIIê°€ 'ìœ ì¶œ'ì¸ì§€ 'ê³µê°œ'ì¸ì§€ íŒë‹¨í•©ë‹ˆë‹¤.
    """
    
    MODEL_NAME = "HCX-005"
    API_URL = config.HCX_API_URL.rstrip('/') + f'/v3/chat-completions/{MODEL_NAME}'
    
    headers = {
        "Authorization": f"Bearer {config.HCX_API_KEY}", 
        "Content-Type": "application/json"
    }

    data = {
        "messages": [
            {
                "role": "system",
                "content": SYSTEM_PROMPT
            },
            {
                "role": "user",
                "content": f"[ë¬¸ë§¥]: \"...{context}...\"\n[íƒì§€ëœ PII]: \"{pii_content}\""
            }
        ],
        "response_format": {
            "type": "json_object" # JSONìœ¼ë¡œ ë‹µí•˜ë„ë¡ ê°•ì œ
        },
        "max_tokens": 100,
        "temperature": 0.1 # ì¼ê´€ëœ ë‹µë³€ì„ ìœ„í•´ ì˜¨ë„ë¥¼ ë‚®ì¶¤
    }

    try:
        response = requests.post(API_URL, headers=headers, data=json.dumps(data), timeout=30)
        response.raise_for_status()
        
        result = response.json()
        
        # --- (âœ¨ í•µì‹¬ ìˆ˜ì •) ---
        # v3 ì‘ë‹µ êµ¬ì¡°ê°€ 'choices'ê°€ ì•„ë‹Œ 'result' í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        json_content = result['result']['message']['content']
        # --- (ìˆ˜ì • ë) ---
        
        llm_answer = json.loads(json_content)
        
        return llm_answer # {"label": "...", "reason": "..."}
        
    except requests.exceptions.ReadTimeout:
        # (âœ¨ ìˆ˜ì •) print -> logger.error
        logger.error("âŒ [LLM API ì—ëŸ¬] HyperCLOVA íƒ€ì„ì•„ì›ƒ")
        return {"label": "ì˜¤ë¥˜", "reason": "íƒ€ì„ì•„ì›ƒ"}
    except Exception as e:
        # (âœ¨ ìˆ˜ì •) print -> logger.error
        logger.error(f"âŒ [LLM API ì—ëŸ¬] {e}")
        if 'response' in locals():
            logger.error(f"    (ì‘ë‹µ: {response.text})")
        return {"label": "ì˜¤ë¥˜", "reason": str(e)}